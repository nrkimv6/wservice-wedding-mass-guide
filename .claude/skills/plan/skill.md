---
name: plan
description: "계획 문서 작성. Use when: 계획해, plan, 아이디어, 기획"
---

# 계획 문서 작성

사용자의 아이디어나 요구사항을 계획 문서로 정리하고, **원자 단위 TODO까지 자동 생성**합니다.

## 트리거

- "계획해", "plan", "아이디어", "기획"
- 새로운 기능이나 개선사항을 논의할 때

## 파일 위치

### 프로젝트 경로 해석

**`.claude/projects.json`에서 프로젝트 경로 읽기:**
```powershell
$configPath = "D:\work\project\service\wtools\.claude\projects.json"
$config = Get-Content $configPath | ConvertFrom-Json
# 각 프로젝트의 절대경로: $config.projects[].path
```

**wtools 감지**: 현재 디렉토리에 `common/` 폴더 존재 여부로 판단
- **있으면**: wtools 내부 → `common/docs/plan/`에 공통 계획 저장 + wtools/TODO.md 동기화 **실행**
- **없으면**: 외부 프로젝트 → `{proj.path}/docs/plan/`에 저장 + wtools/TODO.md 동기화 **스킵**

**TODO는 반드시 프로젝트 단위로 생성한다:**

| 대상 | plan 위치 | TODO 위치 |
|------|----------|----------|
| 단일 프로젝트 | `{proj.path}/docs/plan/` | `{proj.path}/docs/plan/` |
| 복수 프로젝트 | `common/docs/plan/` (wtools만) | **각 프로젝트별** `{proj.path}/docs/plan/` |
| 공통 (스킬, 설정 등) | `common/docs/plan/` (wtools만) | `common/docs/plan/` |

```
# 단일 프로젝트
{project}/docs/plan/YYYY-MM-DD_{주제}.md          # 계획 문서
{project}/docs/plan/YYYY-MM-DD_{주제}_todo.md     # 별도 TODO (모드 B)
{project}/docs/archive/YYYY-MM-DD_{주제}.md       # 아카이브 (모드 B)

# 복수 프로젝트
common/docs/plan/YYYY-MM-DD_{주제}.md             # 공통 계획 문서
{project-a}/docs/plan/YYYY-MM-DD_{주제}_todo.md   # 프로젝트A TODO
{project-b}/docs/plan/YYYY-MM-DD_{주제}_todo.md   # 프로젝트B TODO

# 공통 (특정 프로젝트 없음: 스킬, 설정, 인프라 등)
common/docs/plan/YYYY-MM-DD_{주제}.md             # 계획 문서
common/docs/plan/YYYY-MM-DD_{주제}_todo.md        # TODO
```

## 실행 단계

### 1단계: 요구사항 파악

사용자에게 다음을 확인:
- 대상 프로젝트 (없으면 전체 공통)
- 구현하고 싶은 기능/개선사항
- 우선순위 (있다면)

### 2단계: 코드베이스 분석

**반드시 대상 프로젝트의 실제 코드를 읽고** 계획을 세운다:
- 수정 대상 파일의 현재 코드 확인
- 기존 패턴, 컨벤션 파악
- 의존성 및 영향 범위 확인

### 3단계: 계획 문서 작성 + 모드 선택

계획 문서를 작성한 뒤, **분량에 따라 모드를 선택**하고 해당 헬퍼 파일을 읽어 실행한다.

| 모드 | 판단 기준 | 헬퍼 파일 |
|------|----------|----------|
| **모드 A** | 한눈에 읽히는 분량 (Phase 1-2개, 작업 5개 이하) | `_mode-a.md` |
| **모드 B** | 스크롤이 길어지는 분량 (Phase 3개+, 작업 6개+) | `_mode-b.md` |

**실행:** 모드 판단 후, 같은 폴더의 해당 헬퍼 파일을 **Read 도구로 읽고** 지시에 따른다.

### 4단계: wtools/TODO.md 동기화 (wtools만 해당)

**wtools 감지 조건**: 현재 디렉토리에 `common/` 폴더가 있는지 확인
- **있으면**: wtools 내부 → 아래 동기화 실행
- **없으면**: 외부 프로젝트 → 이 단계 **스킵**

1. **wtools/TODO.md를 Read로 연다**
2. **대상 프로젝트 섹션을 찾는다** (없으면 생성)
3. **항목이 이미 있는지 확인한다**
   - 있으면 스킵 (중복 방지)
   - 없으면 Pending에 새 항목 추가: `- [ ] {제목} — [plan 또는 todo]({경로}) (0/N, 0%)`
4. **"마지막 업데이트" 날짜를 오늘로 Edit**
5. **반드시 Edit 완료 후 다시 Read하여 반영을 확인한다** (Read → Edit → Read 패턴)

### 5단계: 최종 검증 (필수)

모드에 관계없이, 안내 출력 **전에** 아래를 순차적으로 확인한다:

1. **plan 문서가 올바른 위치에 존재하는지 Read로 확인**
   - 모드 A: `{project}/docs/plan/` 또는 `common/docs/plan/`
   - 모드 B: `{project}/docs/archive/` 또는 `common/docs/archive/`
   - 실패 시: 3단계로 돌아가 파일 생성

2. **TODO 항목이 plan 내부(모드A) 또는 _todo.md(모드B)에 존재하는지 확인**
   - 모드 A: plan 문서 내 "## 구현 순서" 섹션에 체크박스 존재
   - 모드 B: `{project}/docs/plan/YYYY-MM-DD_{주제}_todo.md` 파일 존재
   - 실패 시: 3단계로 돌아가 TODO 생성

3. **모드B일 경우 _todo.md 내 archive 역참조 경로가 유효한지 확인**
   - _todo.md의 첫 줄에 `> 계획: [링크](archive 경로)` 존재
   - Read로 해당 archive 경로가 실제로 열리는지 확인
   - 실패 시: 3단계로 돌아가 역참조 수정

4. **대상 프로젝트 TODO.md의 Pending에 항목이 존재하는지 확인**
   - `{project}/TODO.md` 또는 `common/TODO.md` Read
   - Pending 섹션에 해당 plan 링크가 포함된 항목 존재
   - 실패 시: 4단계로 돌아가 TODO.md에 추가

5. **wtools/TODO.md에 해당 plan 링크가 존재하는지 확인**
   - `wtools/TODO.md` Read
   - 해당 프로젝트 섹션에 plan 링크가 포함된 항목 존재
   - "마지막 업데이트" 날짜가 오늘인지 확인
   - 실패 시: 4단계로 돌아가 wtools/TODO.md 동기화

**⚠️ 중요: 하나라도 실패 시 → 해당 단계로 돌아가 수정. 모든 검증 통과 전 6단계 진행 금지.**

### 6단계: 안내

```
계획 문서 생성 완료

[모드 A]
plan: common/docs/plan/YYYY-MM-DD_{주제}.md (분석 + TODO 포함)

[모드 B]
plan: {archive 경로} (분석용, 아카이브됨)
todo: common/docs/plan/YYYY-MM-DD_{주제}_todo.md (N phases, M tasks)

다음 단계:
- 검토 후 수정이 필요하면 말씀해주세요
- 구현을 시작하려면 "다음" 또는 "구현해"라고 말씀해주세요
```

---

## 검증 섹션 작성 규칙 (Python/백엔드 한정)

**대상**: Python 코드를 수정하는 plan에는 반드시 `## 검증` 섹션을 포함한다.

**비대상**: 프론트엔드(SvelteKit/Astro), PS1 스크립트 등은 검증 섹션 생략 가능.
- 프론트엔드는 `/webapp-testing` 스킬로 별도 검증
- PS1 스크립트는 운영 환경 의존으로 CLI 단위 검증 불가

**검증 섹션 필수 항목**:

| 항목 | 내용 | 예시 |
|------|------|------|
| **테스트 실행 명령** | 수정 대상에 대한 pytest 명령어 (절대경로) | `python -m pytest D:\...\tests\auto_next\ -v` |
| **기대 결과** | passed 수, 실행시간 상한 등 구체적 수치 | `24 passed, < 30초` |
| **회귀 확인** | 기존 테스트가 깨지지 않는지 확인하는 명령어 | `python -m pytest D:\...\tests\ --ignore=...` |
| **검증 기준 체크리스트** | 통과/실패를 판단할 수 있는 체크박스 | `- [ ] 새 테스트 전부 passed` |

**작성 위치**: TODO 체크리스트 바로 위 (모드 A), 또는 _todo.md 하단 (모드 B)

**테스트가 없는 경우**: "수동 검증" 항목으로 대체 (API 호출 curl/httpie 명령, DB 상태 확인 쿼리 등)

## 원자 작업 기준 (모드 A, B 공통)

| 조건 | 설명 |
|------|------|
| 단일 파일 | 하나의 파일만 수정 (또는 밀접한 2-3개) |
| 명확한 변경 | "무엇을 어떻게 바꾸는지" 한 줄로 설명 가능 |
| 독립 실행 | 같은 Phase 내에서 순서대로 실행하면 됨 |
| 초보 실행 가능 | 코드베이스를 처음 보는 사람도 실행 가능 |

각 원자 작업에 **대상 파일 경로**를 반드시 포함한다.

## 멀티레벨 TODO 구조 (필수)

**모든 TODO는 2레벨 구조로 작성한다:**

```markdown
### Phase N: {Phase 이름}

1. [ ] **{상위 작업}** — 개념적 단위
   - [ ] `{파일경로}`: {구체적 변경 1}
   - [ ] `{파일경로}`: {구체적 변경 2}

2. [ ] **{상위 작업}** — 개념적 단위
   - [ ] `{파일경로}`: {구체적 변경}
```

### 분해 규칙

| 레벨 | 용도 | 예시 |
|------|------|------|
| **상위** (번호) | 기능/개념 단위, 검토 체크포인트 | "로그인 폼 구현", "API 엔드포인트 추가" |
| **하위** (대시) | 초보 할당 가능한 원자 작업 | "`LoginForm.svelte`: email input 추가" |

### 분해 판단 기준

상위 작업을 하위로 분해해야 하는 경우:
- 파일을 2개 이상 수정해야 할 때
- "~하고 ~한다"처럼 AND로 연결된 작업
- 예상 소요 시간이 30분 이상일 때
- 중간 검증이 필요한 경우

### 하위 작업 작성 원칙

1. **한 줄에 한 동작**: "추가", "수정", "삭제" 중 하나만
2. **파일 경로 필수**: 어느 파일인지 명확히
3. **구체적 내용**: "버튼 추가" (X) → "Submit 버튼에 disabled 속성 추가" (O)
4. **독립 테스트 가능**: 이것만 해도 뭔가 확인할 수 있어야 함
5. **함수 수준 명세** (중간+ 복잡도):
   - 새 함수: `함수명(파라미터) → 반환값` + 핵심 로직 1줄
   - 기존 함수 수정: 함수명 + 변경할 부분 + before/after 요약
6. **검증 방법 명시**: "이걸 하면 어떻게 확인하나"를 한 줄로

### 복잡도별 분해 깊이

| 복잡도 | 기준 | 분해 수준 | 예시 |
|--------|------|----------|------|
| **낮음** | 설정 변경, 값 추가, 1곳 수정 | 파일 + 위치 | "`config.ts`: timeout 값 30→60으로 변경" |
| **중간** | 새 함수 작성, 로직 추가 | 함수 시그니처 + 동작 | "`Parse-Result($output) → hashtable`: 정규식으로 블록 파싱" |
| **높음** | 여러 함수 연동, 흐름 변경 | 함수별 각각 + 연결 순서 | 함수 A, 함수 B 각각 작성 후 호출부 수정 — 별도 TODO |

**승격 규칙**: 하나의 상위 작업에 하위가 5개 이상이면 별도 Phase로 승격 검토

## 코드블럭 내 체크박스 규칙

**문제**: `/done` 스킬의 체크박스 파싱이 코드블럭/인라인 코드 내 `[ ]`도 미완료로 카운트하여 아카이브 실패

**규칙**: 코드블럭이나 인라인 코드 안에 체크박스 **예시**를 넣을 때는 반드시 유니코드로 치환

| 용도 | 사용 금지 | 사용 필수 |
|------|----------|----------|
| 미완료 예시 | `- [ ]` | `- ☐` (U+2610) |
| 완료 예시 | `- [x]` | `- ☑` (U+2611) 또는 `- [x]` |

**적용 대상**:
- 코드블럭(` ``` `) 안의 TODO/체크박스 예시
- 인라인 코드(`` ` ``) 안의 체크박스 패턴
- 마크다운 테이블 내 예시 코드

**참고**: [2026-02-18_fix-checkbox-in-codeblock.md](../../../common/docs/archive/2026-02-18_fix-checkbox-in-codeblock.md)

## 문서 상태 & 진행률

단일 상태 필드로 plan 문서의 전체 생명주기를 관리한다:

```
초안 → 검토대기 → 검토완료 → 구현중 → 구현완료
         ↘ 수정필요 → 검토대기 (루프)
         ↘ 보류
```

| 상태 | 의미 | 전이 조건 |
|------|------|----------|
| `초안` | /plan 스킬로 최초 작성됨 | plan 작성 시 자동 |
| `검토대기` | 검토 요청 상태 | 사용자가 검토 요청 시 |
| `수정필요` | 검토 후 변경 필요 | 검토자가 피드백 시 |
| `검토완료` | auto-plan(opus) 보완 완료 | auto-plan 완료 시 자동 |
| `구현중` | 구현 착수됨 | /implement 또는 /next 시 자동 |
| `구현완료` | 모든 항목 완료 | /done 시 자동 |
| `보류` | 우선순위 밀림 또는 의존성 대기 | 수동 |

**진행률 업데이트 규칙:**
- 헤더와 푸터에 `진행률: 완료수/전체 (백분율%)` 표시
- `[x]` 개수를 세어 자동 계산

## 우선순위 기준

| 우선순위 | 기준 |
|:-------:|------|
| P0 | 즉시 실행 가능, 핵심 기능 |
| P1 | 중요하지만 P0 이후 |
| P2 | 있으면 좋은 기능 |
| P3 | 장기 과제 |

## 난이도 기준

| 난이도 | 기준 |
|:-----:|------|
| 낮음 | 1-2시간, 단순 구현 |
| 중간 | 반나절, 여러 파일 수정 |
| 높음 | 하루 이상, 아키텍처 변경 |

## 환경

- **Windows**: 백슬래시(`\`), 절대경로, PowerShell 전용
